<!DOCTYPE HTML><html lang="en"><head><title>DIY Flow Bench %TEMPLATE_TEST%</title><meta name="viewport" content="width=device-width,initial-scale=1"><style>body,html{height:100%;margin:0;font-family:Arial;font-size:22px}.tablink{background-color:#555;color:#fff;float:left;border:none;outline:0;cursor:pointer;padding:18px 1pc;font-size:22px;width:50%}.tablink:active,.tablink:hover{background-color:#777}.tabcontent{display:none;padding:75pt 20px;height:100%}#About,#Contact,#Home,#News{background-color:#fff}html{font-family:Helvetica;display:inline-block;margin:0 auto}.headerbar{overflow:hidden;background-color:#0a1128;text-align:center}.headerbar h1 a:active,.headerbar h1 a:hover,.headerbar h1 a:link,.headerbar h1 a:visited{color:#fff;text-decoration:none}h1{color:#fff}p{font-size:1.5rem}a:active,a:link,a:visited{color:#0a1128;text-decoration:none}a:hover{color:#666;text-decoration:none}hr{clear:both}.content{padding:30px}.float-right{float:right}.align-center{text-align:center}.clear-both{clear:both}.tile-grid{max-width:700px;margin:0 auto;display:grid;grid-gap:2rem;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr))}.tile{background-color:#fff;box-shadow:2px 2px 9pt 1px hsla(0,0%,55%,.5);text-align:center}.tile-title{font-size:1rem;font-weight:700;color:#034078}.tile-value{font-size:2.1rem;font-weight:700;color:#333}.config-panel{max-width:500px;margin:auto}.config-row{margin-top:5px}.config-label{padding-left:5%}.config-value{padding-right:5%;width:34%;float:right}.config-text{width:40%;float:right}.config-select{width:41.5%;float:right}.units{font-size:.8rem;color:#666}.status_message{font-size:1.2rem;color:#666}#footer{clear:both;text-align:center}.hidden_div{display:none}.button{padding:9pt;font-size:22px;width:150px}.button,.button-sml{display:inline-block;background-color:#008cba;border:none;border-radius:4px;color:#fff;text-decoration:none;margin:2px;cursor:pointer}.button-sml{float:right;padding:6px;font-size:9pt}#record-button{background-color:#fa2e04}#save-button{background-color:#44b112}#calibrate-button{background-color:#fa2e04}#file-manager-button,#status-button{width:48%}#on-button{background-color:#44b112}#delete-button,#off-button{background-color:#fa2e04}.tooltip{position:relative;border-bottom:1px dotted #000}.tooltip .tooltiptext{visibility:hidden;width:250px;background-color:#666;color:#fff;text-align:center;border-radius:6px;padding:5px;position:absolute;z-index:1;bottom:150%;left:50%;margin-left:-60px}.tooltip .tooltiptext:after{content:"";position:absolute;top:100%;left:50%;margin-left:-5px;border-width:5px;border-style:solid;border-color:#000 transparent transparent}.tooltip:hover .tooltiptext{visibility:visible}.modal{display:none;position:fixed;z-index:1;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:#000;background-color:rgba(0,0,0,.4)}.modal-content{background-color:#fefefe;margin:15% auto;padding:20px;border:1px solid #888;width:65%;border-radius:5px}@media screen and (max-width:800px){.modal-content{width:100%}}.file-upload-button{padding:9pt 0;text-align:center}input[type=file]{display:none}.closeFileModal,.closeStatusModal,.closeUploadModal{color:#aaa;float:right;font-size:22px;font-weight:700}.closeFileModal:focus,.closeFileModal:hover,.closeStatusModal:focus,.closeStatusModal:hover{color:#000;text-decoration:none;cursor:pointer}.fileSizeTxt{padding:10px}.fileDelLink{padding:10px;left:75pt}.file-link,.fileDelLink{cursor:pointer}.fileListRow{margin-bottom:10px}.column{float:left;height:40px}.left{width:55%;height:40px}.middle{width:25%}.right{width:10%}.row:after{content:"";display:table;clear:both}.graph-container{margin-top:50px;text-align:center}svg.graph{height:500px;width:50pc}svg.graph .grid{stroke:grey;stroke-dasharray:1 2;stroke-width:1}svg.graph .points{stroke:#fff;stroke-width:3}svg.graph .first_set{fill:#00554d}svg.graph .surfaces{fill-opacity:.5}svg.graph .grid.double{stroke-opacity:.4}svg.graph .labels{font-family:Arial;font-size:14px;kerning:1}svg.graph .labels.x-labels{text-anchor:middle}svg.graph .labels.y-labels{text-anchor:end}.prefTestOK{color:#90ee90}.prefTestNOK,.prefTestOK{font-size:2.1rem;font-weight:700}.prefTestNOK{color:red}</style></head><body><div id="fileModal" class="modal"><div class="modal-content"><span class="closeFileModal">&times;</span><h3>File Manager</h3><div id="file_list">Loading...</div><br><hr><br><form method="POST" action="/upload" enctype="multipart/form-data"><label for="data" class="file-upload-button button">Select File</label> <input id="data" type="file" name="wtf"> <input class="button file-submit-button" type="submit" value="Upload"></form></div></div><div id="statusModal" class="modal"><div class="modal-content"><span class="closeStatusModal">&times;</span><h3>System Status</h3><h4>Firmware</h4><div class="config-row"><label class="config-label">Version:</label><span class="config-value" id="RELEASE">Loading...</span></div><div class="config-row"><label class="config-label">Build:</label><span class="config-value" id="BUILD_NUMBER">Loading...</span></div><h4>Storage</h4><hr><div class="config-row"><label class="config-label">Memory Size:</label><span class="config-value" id="SPIFFS_MEM_SIZE">Loading...</span> (bytes)</div><div class="config-row"><label class="config-label">Memory Used:</label><span class="config-value" id="SPIFFS_MEM_USED">Loading...</span> (bytes)</div><h4>Network</h4><hr><div class="config-row"><label class="config-label">IP Address:</label><span class="config-value" id="LOCAL_IP_ADDRESS">Loading...</span></div><h4>Hardware Configuration</h4><hr><div class="config-row"><label class="config-label">Bench Type:</label><span class="config-value" id="BENCHTYPE">Loading...</span></div><div class="config-row"><label class="config-label">Board Type:</label><span class="config-value" id="BOARDTYPE">Loading...</span></div><h4>Sensor Configuration</h4><hr><div class="config-row"><label class="config-label">MAF Data File:</label><span class="config-value" id="MAF_SENSOR">Loading...</span></div><div class="config-row"><label class="config-label">Ref Press Sensor:</label><span class="config-value" id="PREF_SENSOR">Loading...</span></div><div class="config-row"><label class="config-label">Temp Sensor:</label><span class="config-value" id="TEMP_SENSOR">Loading...</span></div><div class="config-row"><label class="config-label">Humidity Sensor:</label><span class="config-value" id="RELH_SENSOR">Loading...</span></div><div class="config-row"><label class="config-label">Baro Sensor:</label><span class="config-value" id="BARO_SENSOR">Loading...</span></div><div class="config-row"><label class="config-label">Pitot Sensor:</label><span class="config-value" id="PITOT_SENSOR">Loading...</span></div></div></div><div class="headerbar"><h1><a href="/" id="PAGE_TITLE" alt="DIY Flow Bench">DIY Flow Bench</a></h1></div><button class="tablink" onclick="openPage('dashboard', this)" id="load-dashboard-button">Dashboard</button> <button class="tablink" onclick="openPage('configuration', this)" id="load-config-button">Configuration</button><div id="dashboard" class="tabcontent"><div class="content"><div class="tile-grid"><div class="tile tile-pref"><p class="tile-title">Ref Pressure</p><p><span class="tile-value" id="PREF">&nbsp;</span></p><p class="units">In/Aq</p></div><div class="tile tile-flow"><p class="tile-title">Flow Rate</p><p><span class="tile-value" id="FLOW">&nbsp;</span></p><p class="units">cfm</p></div><div class="tile tile-pitot"><p class="tile-title">Pitot</p><p><span class="tile-value" id="PITOT">&nbsp;</span></p><p class="units">In/Aq</p></div><div class="tile tile-temp"><p class="tile-title">Temperature</p><p><span class="tile-value" id="TEMP">&nbsp;</span></p><p class="units">Deg</p></div><div class="tile tile-baro"><p class="tile-title">Baro Pressure</p><p><span class="tile-value" id="BARO">&nbsp;</span></p><p class="units">millibar (hPa)</p></div><div class="tile tile-relh"><p class="tile-title">Humidity</p><p><span class="tile-value" id="RELH">&nbsp;</span></p><p class="units">&percnt;RH</p></div></div></div><div class="align-center"><div class="status_message"><span id="STATUS_MESSAGE">&nbsp;</span></div><div class="hidden_div"><br>Ref Pressure mV: <span id="PREF_MV">&nbsp;</span><br>MAF mV: <span id="MAF_MV">&nbsp;</span><br>Pitot mV: <span id="PITOT_MV">&nbsp;</span></div><p><button id="refresh-button" class="button">Refresh</button> <button id="on-button" class="button">ON</button> <button id="off-button" class="button">OFF</button></p></div><br><div id="footer"><a href="https://diyflowbench.com" target="new">DIYFlowBench.com</a></div></div><form action="#" id="config-form" onsubmit="return false;"><div id="configuration" class="tabcontent"><div class="config-panel"><p><button id="file-manager-button" class="button">File Manager</button>&nbsp;<button id="status-button" class="button">Status</button></p><br><h3>WiFi Info</h3><div class="config-row tooltip"><label class="config-label">WiFi SSID:</label>&nbsp;<input type="text" id="CONF_WIFI_SSID" name="CONF_WIFI_SSID" value="CONF_WIFI_SSID" class="config-text"><span class="tooltiptext">The name of your WiFi network</span></div><div class="config-row tooltip"><label class="config-label">WiFi Password:</label>&nbsp;<input type="text" id="CONF_WIFI_PSWD" name="CONF_WIFI_PSWD" value="CONF_WIFI_PSWD" class="config-text"><span class="tooltiptext">Your WiFi Password</span></div><div class="config-row tooltip"><label class="config-label">WiFi AP SSID:</label>&nbsp;<input type="text" id="CONF_WIFI_AP_SSID" name="CONF_WIFI_AP_SSID" value="CONF_WIFI_AP_SSID" class="config-text"><span class="tooltiptext">Access-point name for direct WiFi connection</span></div><div class="config-row tooltip"><label class="config-label">WiFi AP Password:</label>&nbsp;<input type="text" id="CONF_WIFI_AP_PSWD" name="CONF_WIFI_AP_PSWD" value="CONF_WIFI_AP_PSWD" class="config-text"><span class="tooltiptext">Access-point password</span></div><div class="config-row tooltip"><label class="config-label">Hostname:</label>&nbsp;<input type="text" id="CONF_HOSTNAME" name="CONF_HOSTNAME" value="CONF_HOSTNAME" class="config-text"><span class="tooltiptext">DNS Hostname (used for connecting via URL e.g. http://diyfb.local)</span></div><div class="config-row tooltip"><label class="config-label">WiFi Timeout:</label>&nbsp;<input type="text" id="CONF_WIFI_TIMEOUT" name="CONF_WIFI_TIMEOUT" value="CONF_WIFI_TIMEOUT" class="config-text"><span class="tooltiptext">Number of seconds before WiFi defaults to Access-point mode</span></div><br><h3>API Settings</h3><div class="config-row tooltip"><label class="config-label">API Delimiter:</label>&nbsp;<input type="text" id="CONF_API_DELIM" name="CONF_API_DELIM" value="CONF_API_DELIM" class="config-text"><span class="tooltiptext">Character used to delimit API / Serial data</span></div><div class="config-row tooltip"><label class="config-label">Serial Baud Rate:</label>&nbsp;<input type="text" id="CONF_SERIAL_BAUD_RATE" name="CONF_SERIAL_BAUD_RATE" value="CONF_SERIAL_BAUD_RATE" class="config-text"><span class="tooltiptext">Baud rate for serial communication</span></div><br><h3>Data Filters</h3><div class="config-row tooltip"><label class="config-label">Min Flow Rate:</label>&nbsp;<input type="text" id="CONF_MIN_FLOW_RATE" name="CONF_MIN_FLOW_RATE" value="CONF_MIN_FLOW_RATE" class="config-text"><span class="tooltiptext">Used to filter out non-zero flow values when bench is not running</span></div><div class="config-row tooltip"><label class="config-label">Min Bench Pressure:</label>&nbsp;<input type="text" id="CONF_MIN_BENCH_PRESSURE" name="CONF_MIN_BENCH_PRESSURE" value="CONF_MIN_BENCH_PRESSURE" class="config-text"><span class="tooltiptext">Minimum reference pressure that bench is considered running</span></div><div class="config-row tooltip"><label class="config-label">MAF Min Millivolts:</label>&nbsp;<input type="text" id="CONF_MAF_MIN_MILLIVOLTS" name="CONF_MAF_MIN_MILLIVOLTS" value="CONF_MAF_MIN_MILLIVOLTS" class="config-text"><span class="tooltiptext">Minimum MAF voltage that bench is considered running</span></div><div class="config-row tooltip"><label class="config-label">Cyclical Average Buffer:</label>&nbsp;<input type="text" id="CONF_CYCLIC_AVERAGE_BUFFER" name="CONF_CYCLIC_AVERAGE_BUFFER" value="CONF_CYCLIC_AVERAGE_BUFFER" class="config-text"><span class="tooltiptext">Mean buffer size - Used for smoothing results.</span></div><br><h3>Bench Settings</h3><div class="config-row tooltip"><label class="config-label">Refresh Rate:</label>&nbsp;<input type="text" id="CONF_REFRESH_RATE" name="CONF_REFRESH_RATE" value="CONF_REFRESH_RATE" class="config-text"><span class="tooltiptext">Screen refresh rate in milliseconds</span></div><br><h3>Calibration Settings</h3><div class="config-row tooltip"><label class="config-label">Orifice Flow Rate:</label>&nbsp;<input type="text" id="CONF_CAL_FLOW_RATE" name="CONF_CAL_FLOW_RATE" value="CONF_CAL_FLOW_RATE" class="config-text"><span class="tooltiptext">Flow rate of calibration orifice</span></div><div class="config-row tooltip"><label class="config-label">Orifice Test Pressure:</label>&nbsp;<input type="text" id="CONF_CAL_REF_PRESS" name="CONF_CAL_REF_PRESS" value="CONF_CAL_REF_PRESS" class="config-text"><span class="tooltiptext">Reference pressure of calibration orifice</span></div><div class="config-row tooltip"><label class="config-label">Leak Test Tolerance:</label>&nbsp;<input type="text" id="CONF_LEAK_TEST_TOLERANCE" name="CONF_LEAK_TEST_TOLERANCE" value="CONF_LEAK_TEST_TOLERANCE" class="config-text"><span class="tooltiptext">Maximum allowable deviation in cfm</span></div><div class="config-row tooltip"><label class="config-label">Leak Test Threshold:</label>&nbsp;<input type="text" id="CONF_LEAK_TEST_THRESHOLD" name="CONF_LEAK_TEST_THRESHOLD" value="CONF_LEAK_TEST_THRESHOLD" class="config-text"><span class="tooltiptext">Value above which leak test activates</span></div><br><div class="float-right"><button id="save-config-button" class="button">Save</button></div><br><br><h3>Calibration Data</h3><div class="config-row tooltip"><label class="config-label">Calibration Offset:</label>&nbsp;<input disabled="disabled" type="text" id="FLOW_OFFSET" name="FLOW_OFFSET" value="FLOW_OFFSET" class="config-text"><span class="tooltiptext">Measured calibration offset</span></div><div class="config-row tooltip"><label class="config-label">Leak Test Value:</label>&nbsp;<input disabled="disabled" type="text" id="LEAK_CAL_VAL" name="LEAK_CAL_VAL" value="LEAK_CAL_VAL" class="config-text"><span class="tooltiptext">Measured leak test value</span></div><br><div class="float-right"><button id="calibrate-button" class="button">Calibrate Flow Offset</button><button id="leak-cal-button" class="button">Calibrate Leak Test</button></div><br><br><hr><div class="float-right"><button id="restart-button" class="button">Restart</button></div></div></div></form><script>const GET_FLOW_DATA=1,REC_FLOW_DATA=2,CALIBRATE=3,FILE_LIST=4,SYS_STATUS=5,SAVE_CONFIG=6,LOAD_CONFIG=7,FILE_DOWNLOAD=8,FILE_DELETE=9,FILE_UPLOAD=10,START_BENCH=11,STOP_BENCH=12,LEAK_CAL=13,GET_CAL=14;var leakCalVal,flowCalVal,leakCalTolerance,leakTestThreshold,websocket,gateway=`ws://${window.location.hostname}/ws`;window.addEventListener("load",onLoad);var fileModal=document.getElementById("fileModal"),statusModal=document.getElementById("statusModal"),spanCloseFileModal=document.getElementsByClassName("closeFileModal")[0],spanCloseStatusModal=document.getElementsByClassName("closeStatusModal")[0];function initialiseWebSocket(){console.log("Trying to open a WebSocket connection..."),(websocket=new WebSocket(gateway)).onopen=onOpen,websocket.onclose=onClose,websocket.onmessage=onSocketMessageReceive}function onOpen(e){console.log("Connection opened"),socketMessageSend(1),socketMessageSend(7),socketMessageSend(4),socketMessageSend(14)}function onClose(e){console.log("Connection closed"),setTimeout(initialiseWebSocket,2e3)}function onSocketMessageReceive(e){try{var t=JSON.parse(e.data);console.log("Socket Message Event: "+parseInt(t.HEADER))}catch(e){console.log("Malformed JSON data")}switch(key=null,parseInt(t.HEADER)){case 7:for(key in t)try{"HEADER"!=key&&(document.getElementById(key).value=t[key])}catch(e){console.log("Missing or incorrect configuration parameter(s)")}break;case 1:for(key in t)try{"HEADER"!=key&&(document.getElementById(key).innerHTML=t[key],"PREF"==key&&(t[key]>leakCalVal-leakCalTolerance?document.getElementById("PREF").className="prefTestOK":t[key]>leakTestThreshold?document.getElementById("PREF").className="prefTestNOK":document.getElementById("PREF").className="tile-value"))}catch(e){console.log("Missing or incorrect data parameter(s)")}break;case 14:for(key in console.log("get-cal"),t){console.log(key);try{"HEADER"!=key&&(document.getElementById(key).value=t[key],console.log(key+" : "+t[key])),"FLOW_OFFSET"==key&&(flowCalVal=t[key]),"LEAK_CAL_VAL"==key&&(leakCalVal=t[key])}catch(e){console.log("Missing or incorrect calibration parameter(s)")}}break;case 4:var n="";for(key in t){try{"HEADER"!=key&&(n+='<div class="fileListRow"><span class="column left"><a href="/download'+key+'" download class="file-link" onclick="downloadFile("'+key+'")">'+key+'</a></span><span class="column middle"><span class="fileSizeTxt">'+t[key]+' bytes</span></span><span class="column right"><button id="delete-button"  onclick="socketMessageSend(\'9:'+key+'\')" class="button-sml">Del</button></span>')}catch(e){console.log(e),console.log("Missing or incorrect system status")}document.getElementById("file_list").innerHTML=n}break;case 5:for(key in t)try{"HEADER"!=key&&(document.getElementById(key).innerHTML=t[key])}catch(e){console.log("Missing or incorrect status parameter(s)")}}}function onFileUpload(e){this.setState({file:e.target.files[0]});const{file:t}=this.state,n=new FormData;n.append("data",t),fetch("/upload",{method:"POST",body:n}).catch((e=>{console.log("Request failed",e)}))}function onLoad(e){initialiseWebSocket(),initialiseButtons();if("upload"===new URLSearchParams(window.location.search).get("modal"))document.getElementById("load-config-button").click(),document.getElementById("fileModal").style.display="block";else document.getElementById("load-dashboard-button").click();console.log("Page Loaded")}function initialiseButtons(){document.getElementById("refresh-button").addEventListener("click",(function(){socketMessageSend(1)})),document.getElementById("load-config-button").addEventListener("click",(function(){socketMessageSend(7),socketMessageSend(14)})),document.getElementById("calibrate-button").addEventListener("click",(function(){socketMessageSend(3)})),document.getElementById("leak-cal-button").addEventListener("click",(function(){socketMessageSend(13)})),document.getElementById("save-config-button").addEventListener("click",(function(){socketMessageSend(6)})),document.getElementById("file-manager-button").addEventListener("click",(function(){socketMessageSend(4),document.getElementById("fileModal").style.display="block"})),document.getElementById("status-button").addEventListener("click",(function(){socketMessageSend(5),document.getElementById("statusModal").style.display="block"})),document.getElementById("on-button").addEventListener("click",(function(){socketMessageSend(11)})),document.getElementById("off-button").addEventListener("click",(function(){socketMessageSend(12)}))}function configFormArray(){const e=document.querySelectorAll("form")[1],t=new FormData(e),n={};for(const[e,o]of t)n[e]=o;return n}function socketMessageSend(e){var t,n,o,s,a;switch(console.log("Web Socket Message: "+e),-1!=String(e).search(":")?(o=e.split(":"),s=Number(o[0]),a=o[1]):s=e,s){case 1:t='{"HEADER":"1"}';break;case 2:t='{"HEADER":"2"}';break;case 3:t='{"HEADER":"3"}';break;case 4:t='{"HEADER":"4"}';break;case 5:t='{"HEADER":"5"}';break;case 6:(n=configFormArray()).HEADER=6,t=JSON.stringify(n,null,2);break;case 7:t='{"HEADER":"7"}';break;case 8:case 10:break;case 9:t='{"HEADER":"9","FILENAME":"'+a+'"}';break;case 11:t='{"HEADER":"11"}';break;case 12:t='{"HEADER":"12"}';break;case 13:t='{"HEADER":"13"}';break;case 14:t='{"HEADER":"14"}'}console.log(t),websocket.send(t)}function openPage(e,t){var n,o;for(o=document.getElementsByClassName("tabcontent"),n=0;n<o.length;n++)o[n].style.display="none";document.getElementById(e).style.display="block"}spanCloseFileModal.onclick=function(){fileModal.style.display="none"},spanCloseStatusModal.onclick=function(){statusModal.style.display="none"},window.onclick=function(e){e.target!=fileModal&&e.target!=statusModal||(fileModal.style.display="none",statusModal.style.display="none")},document.addEventListener("keydown",(({key:e})=>{"Escape"===e&&(fileModal.style.display="none",statusModal.style.display="none")}));</script></body></html>