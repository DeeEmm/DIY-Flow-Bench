<!DOCTYPE HTML><html lang="en"><head><title>DIY Flow Bench</title><meta name="viewport" content="width=device-width,initial-scale=1"><style>body,html{height:100vh;margin:0;font-family:Arial;font-size:22px}.tablink{background-color:#555;color:#fff;float:left;border:none;outline:0;cursor:pointer;padding:18px 1pc;font-size:22px;width:50vw}.tablink:active,.tablink:hover{background-color:#777}.tabcontent{display:none;padding:75pt 20px;height:100vh}#About,#Contact,#Home,#News{background-color:#fff}html{font-family:Helvetica;display:inline-block;margin:0 auto}.headerbar{overflow:hidden;background-color:#0a1128;text-align:center}.headerbar h1 a:active,.headerbar h1 a:hover,.headerbar h1 a:link,.headerbar h1 a:visited{color:#fff;text-decoration:none}h1{color:#fff}p{font-size:1.5rem}a:active,a:link,a:visited{color:#0a1128;text-decoration:none}a:hover{color:#666;text-decoration:none}hr{clear:both}.content{padding:30px}.float-right{float:right}.align-center{text-align:center}.clear-both{clear:both}.tile-grid{max-width:700px;margin:0 auto;display:grid;grid-gap:2rem;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr))}.tile{background-color:#fff;box-shadow:2px 2px 9pt 1px #666;text-align:center}.tile-title{font-size:1rem;font-weight:700;color:#034078}.tile-value{font-size:2.1rem;font-weight:700;color:#333}.config-panel{max-width:650px;margin:auto}.config-row{margin-top:5px}.config-label{padding-left:5px}.config-value{padding-right:50px;width:300px;float:right}.config-text{width:200px;float:right}.config-select{width:41.5vw;float:right}.units{font-size:.8rem;color:#666}.status_message{font-size:1.2rem;color:#666}#footer{clear:both;text-align:center}.hidden_div{display:none}.button{display:inline-block;padding:9pt;font-size:22px;width:150px}.button,.button-sml{background-color:#008cba;border:none;border-radius:4px;color:#fff;text-decoration:none;margin:2px;cursor:pointer}.button-sml{float:right;padding:6px;font-size:9pt}#record-button{background-color:#fa2e04}#save-button{background-color:#44b112}#calibrate-button{background-color:#fa2e04}#about-button,#file-manager-button,#restart-button,#support-button{width:90pt;height:50px}#on-button{background-color:#44b112}#delete-button,#off-button,#restart-button{background-color:#fa2e04}#upload-form{float:right}.tooltip{position:relative;border-bottom:1px dotted #000}.tooltip .tooltiptext{visibility:hidden;width:350px;background-color:#666;color:#fff;text-align:center;border-radius:6px;padding:5px;position:absolute;z-index:1;left:-10px;top:-5px}.tooltip .tooltiptext:after{content:"";position:absolute;top:100vh;left:50vw;margin-left:-5px;border-width:5px;border-style:solid;border-color:#000 transparent transparent}.tooltip:hover .tooltiptext{visibility:visible}.modal{display:none;position:fixed;z-index:1;left:0;padding-top:50px;width:100vw;height:100vh;overflow:auto;background-color:#000;background-color:rgba(0,0,0,.4)}.modal-content{background-color:#fefefe;margin:1px auto;padding:20px;border:1px solid #888;width:850px;border-radius:5px}@media screen and (max-width:800px){.modal-content{width:100vw}}.file-upload-button{padding:9pt 0;text-align:center}input[type=file]{display:none}.closeAboutModal,.closeFileModal,.closeUploadModal{color:#aaa;float:right;font-size:22px;font-weight:700}.closeAboutModal:focus,.closeAboutModal:hover,.closeFileModal:focus,.closeFileModal:hover{color:#000;text-decoration:none;cursor:pointer}.fileSizeTxt{padding:10px}.fileDelLink{padding:10px;left:75pt}.file-link,.fileDelLink{cursor:pointer}.fileListRow{margin-bottom:10px}.column{float:left;height:40px}.left{width:350px;height:40px}.middle{width:200px}.right{width:75pt}.row:after{content:"";display:table;clear:both}.graph-container{margin-top:50px;text-align:center}svg.graph{height:500px;width:50pc}svg.graph .grid{stroke:grey;stroke-dasharray:1 2;stroke-width:1}svg.graph .points{stroke:#fff;stroke-width:3}svg.graph .first_set{fill:#00554d}svg.graph .surfaces{fill-opacity:.5}svg.graph .grid.double{stroke-opacity:.4}svg.graph .labels{font-family:Arial;font-size:14px;kerning:1}svg.graph .labels.x-labels{text-anchor:middle}svg.graph .labels.y-labels{text-anchor:end}.prefTestOK{color:#90ee90}.prefTestNOK,.prefTestOK{font-size:2.1rem;font-weight:700}.prefTestNOK{color:red}</style></head><body><div id="fileModal" class="modal"><div class="modal-content"><span class="closeFileModal">&times;</span><h3>File Manager</h3><div id="file_list">%FILE_LIST%</div><br><hr><br><div class="float-right"><form method="POST" action="/upload" enctype="multipart/form-data"><label for="data" class="file-upload-button button">Select File</label> <input id="data" type="file" name="wtf"> <input class="button file-submit-button" type="submit" value="Upload"></form></div><div class="clear-both">&nbsp;</div></div></div><div id="aboutModal" class="modal"><div class="modal-content"><span class="closeAboutModal">&times;</span><h3>DIY Flow Bench</h3><h4>Firmware</h4><hr><div class="config-row"><label class="config-label">Version:</label><span class="config-value" id="xRELEASE">%RELEASE%</span></div><div class="config-row"><label class="config-label">Build:</label><span class="config-value" id="xBUILD_NUMBER">%BUILD_NUMBER%</span></div><h4>Storage</h4><hr><div class="config-row"><label class="config-label">Memory Size:</label><span class="config-value" id="xSPIFFS_MEM_SIZE">%SPIFFS_MEM_SIZE%</span> (bytes)</div><div class="config-row"><label class="config-label">Memory Used:</label><span class="config-value" id="xSPIFFS_MEM_USED">%SPIFFS_MEM_USED%</span> (bytes)</div><h4>Network</h4><hr><div class="config-row"><label class="config-label">IP Address:</label><span class="config-value" id="xLOCAL_IP_ADDRESS">%LOCAL_IP_ADDRESS%</span></div><h4>Hardware Configuration</h4><hr><div class="config-row"><label class="config-label">Bench Type:</label><span class="config-value" id="xBENCHTYPE">%BENCHTYPE%</span></div><div class="config-row"><label class="config-label">Board Type:</label><span class="config-value" id="xBOARDTYPE">%BOARDTYPE%</span></div><h4>Sensor Configuration</h4><hr><div class="config-row"><label class="config-label">MAF Data File:</label><span class="config-value" id="xMAF_SENSOR">%MAF_SENSOR%</span></div><div class="config-row"><label class="config-label">Ref Press Sensor:</label><span class="config-value" id="xPREF_SENSOR">%PREF_SENSOR%</span></div><div class="config-row"><label class="config-label">Temp Sensor:</label><span class="config-value" id="xTEMP_SENSOR">%TEMP_SENSOR%</span></div><div class="config-row"><label class="config-label">Humidity Sensor:</label><span class="config-value" id="xRELH_SENSOR">%RELH_SENSOR%</span></div><div class="config-row"><label class="config-label">Baro Sensor:</label><span class="config-value" id="xBARO_SENSOR">%BARO_SENSOR%</span></div><div class="config-row"><label class="config-label">Pitot Sensor:</label><span class="config-value" id="xPITOT_SENSOR">%PITOT_SENSOR%</span></div><div class="config-row"><label class="config-label">Differential Sensor:</label><span class="config-value" id="xPDIFF_SENSOR">%PDIFF_SENSOR%</span></div></div></div><div class="headerbar"><h1><a href="/" id="PAGE_TITLE" alt="DIY Flow Bench">DIY Flow Bench</a></h1></div><button class="tablink" onclick="openPage('dashboard', this)" id="load-dashboard-button">Dashboard</button> <button class="tablink" onclick="openPage('configuration', this)" id="load-config-button">Configuration</button><div id="dashboard" class="tabcontent"><div class="content"><div class="tile-grid"><div class="tile tile-pref"><p class="tile-title">Ref Pressure</p><p><span class="tile-value" id="PREF">&nbsp;</span></p><p class="units">In/Aq</p></div><div class="tile tile-flow"><p class="tile-title">Flow Rate</p><p><span class="tile-value" id="FLOW">&nbsp;</span></p><p class="units">cfm</p></div><div class="tile tile-pitot"><p class="tile-title">Pitot</p><p><span class="tile-value" id="PITOT">&nbsp;</span></p><p class="units">In/Aq</p></div><div class="tile tile-temp"><p class="tile-title">Temperature</p><p><span class="tile-value" id="TEMP">&nbsp;</span></p><p class="units">Deg</p></div><div class="tile tile-baro"><p class="tile-title">Baro Pressure</p><p><span class="tile-value" id="BARO">&nbsp;</span></p><p class="units">millibar (hPa)</p></div><div class="tile tile-relh"><p class="tile-title">Humidity</p><p><span class="tile-value" id="RELH">&nbsp;</span></p><p class="units">&percnt;RH</p></div></div></div><div class="align-center"><div class="status_message"><span id="STATUS_MESSAGE">&nbsp;</span></div><div class="hidden_div"><br>Ref Pressure mV: <span id="PREF_MV">&nbsp;</span><br>MAF mV: <span id="MAF_MV">&nbsp;</span><br>Pitot mV: <span id="PITOT_MV">&nbsp;</span></div><p><button id="on-button" class="button">START</button> <button id="off-button" class="button">STOP</button></p></div><br><div id="footer"><a href="https://diyflowbench.com" target="new">DIYFlowBench.com</a></div></div><div id="configuration" class="tabcontent"><div class="config-panel"><p style="text-align:center"><button id="file-manager-button" class="button">Files</button> <button id="about-button" class="button">About</button> <button id="support-button" class="button" onclick="window.open('https://github.com/DeeEmm/DIY-Flow-Bench/wiki','_blank')">Support</button> <button id="restart-button" class="button">Reboot</button></p><br><form method="POST" action="/saveconfig"><h3>WiFi Info</h3><div class="config-row tooltip"><label class="config-label">WiFi SSID:</label>&nbsp;<input type="text" id="CONF_WIFI_SSID" name="CONF_WIFI_SSID" value="%CONF_WIFI_SSID%" class="config-text"><span class="tooltiptext">The name of your WiFi network</span></div><div class="config-row tooltip"><label class="config-label">WiFi Password:</label>&nbsp;<input type="text" id="CONF_WIFI_PSWD" name="CONF_WIFI_PSWD" value="%CONF_WIFI_PSWD%" class="config-text"><span class="tooltiptext">Your WiFi Password</span></div><div class="config-row tooltip"><label class="config-label">WiFi AP SSID:</label>&nbsp;<input type="text" id="CONF_WIFI_AP_SSID" name="CONF_WIFI_AP_SSID" value="%CONF_WIFI_AP_SSID%" class="config-text"><span class="tooltiptext">Access-point name for direct WiFi connection</span></div><div class="config-row tooltip"><label class="config-label">WiFi AP Password:</label>&nbsp;<input type="text" id="CONF_WIFI_AP_PSWD" name="CONF_WIFI_AP_PSWD" value="%CONF_WIFI_AP_PSWD%" class="config-text"><span class="tooltiptext">Access-point password</span></div><div class="config-row tooltip"><label class="config-label">Hostname:</label>&nbsp;<input type="text" id="CONF_HOSTNAME" name="CONF_HOSTNAME" value="%CONF_HOSTNAME%" class="config-text"><span class="tooltiptext">DNS Hostname (used for connecting via URL e.g. http://diyfb.local)</span></div><div class="config-row tooltip"><label class="config-label">WiFi Timeout:</label>&nbsp;<input type="text" id="CONF_WIFI_TIMEOUT" name="CONF_WIFI_TIMEOUT" value="%CONF_WIFI_TIMEOUT%" class="config-text"><span class="tooltiptext">Number of seconds before WiFi defaults to Access-point mode</span></div><br><h3>API Settings</h3><div class="config-row tooltip"><label class="config-label">API Delimiter:</label>&nbsp;<input type="text" id="CONF_API_DELIM" name="CONF_API_DELIM" value="%CONF_API_DELIM%" class="config-text"><span class="tooltiptext">Character used to delimit API / Serial data</span></div><div class="config-row tooltip"><label class="config-label">Serial Baud Rate:</label>&nbsp;<input type="text" id="CONF_SERIAL_BAUD_RATE" name="CONF_SERIAL_BAUD_RATE" value="%CONF_SERIAL_BAUD_RATE%" class="config-text"><span class="tooltiptext">Baud rate for serial communication</span></div><br><h3>Data Filters</h3><div class="config-row tooltip"><label class="config-label">Min Flow Rate:</label>&nbsp;<input type="text" id="CONF_MIN_FLOW_RATE" name="CONF_MIN_FLOW_RATE" value="%CONF_MIN_FLOW_RATE%" class="config-text"><span class="tooltiptext">Used to filter out non-zero flow values when bench is not running</span></div><div class="config-row tooltip"><label class="config-label">Min Bench Pressure:</label>&nbsp;<input type="text" id="CONF_MIN_BENCH_PRESSURE" name="CONF_MIN_BENCH_PRESSURE" value="%CONF_MIN_BENCH_PRESSURE%" class="config-text"><span class="tooltiptext">Minimum reference pressure that bench is considered running</span></div><div class="config-row tooltip"><label class="config-label">MAF Min Millivolts:</label>&nbsp;<input type="text" id="CONF_MAF_MIN_MILLIVOLTS" name="CONF_MAF_MIN_MILLIVOLTS" value="%CONF_MAF_MIN_MILLIVOLTS%" class="config-text"><span class="tooltiptext">Minimum MAF voltage that bench is considered running</span></div><div class="config-row tooltip"><label class="config-label">Cyclical Average Buffer:</label>&nbsp;<input type="text" id="CONF_CYCLIC_AVERAGE_BUFFER" name="CONF_CYCLIC_AVERAGE_BUFFER" value="%CONF_CYCLIC_AVERAGE_BUFFER%" class="config-text"><span class="tooltiptext">Mean buffer size - Used for smoothing results.</span></div><br><h3>Bench Settings</h3><div class="config-row tooltip"><label class="config-label">Refresh Rate:</label>&nbsp;<input type="text" id="CONF_REFRESH_RATE" name="CONF_REFRESH_RATE" value="%CONF_REFRESH_RATE%" class="config-text"><span class="tooltiptext">Screen refresh rate in milliseconds</span></div><br><h3>Calibration Settings</h3><div class="config-row tooltip"><label class="config-label">Orifice Flow Rate:</label>&nbsp;<input type="text" id="CONF_CAL_FLOW_RATE" name="CONF_CAL_FLOW_RATE" value="%CONF_CAL_FLOW_RATE%" class="config-text"><span class="tooltiptext">Flow rate of calibration orifice</span></div><div class="config-row tooltip"><label class="config-label">Orifice Test Pressure:</label>&nbsp;<input type="text" id="CONF_CAL_REF_PRESS" name="CONF_CAL_REF_PRESS" value="%CONF_CAL_REF_PRESS%" class="config-text"><span class="tooltiptext">Reference pressure of calibration orifice</span></div><div class="config-row tooltip"><label class="config-label">Leak Test Tolerance:</label>&nbsp;<input type="text" id="CONF_LEAK_TEST_TOLERANCE" name="CONF_LEAK_TEST_TOLERANCE" value="%CONF_LEAK_TEST_TOLERANCE%" class="config-text"><span class="tooltiptext">Maximum allowable deviation in cfm</span></div><div class="config-row tooltip"><label class="config-label">Leak Test Threshold:</label>&nbsp;<input type="text" id="CONF_LEAK_TEST_THRESHOLD" name="CONF_LEAK_TEST_THRESHOLD" value="%CONF_LEAK_TEST_THRESHOLD%" class="config-text"><span class="tooltiptext">Value above which leak test activates</span></div><br><div class="float-right"><input id="save-config-button" type="submit" class="button" value="Save"></div></form><br><br><h3>Calibration Data</h3><div class="config-row tooltip"><label class="config-label">Calibration Offset:</label>&nbsp;<input disabled="disabled" type="text" id="FLOW_OFFSET" name="FLOW_OFFSET" value="%FLOW_OFFSET%" class="config-text"><span class="tooltiptext">Measured calibration offset</span></div><div class="config-row tooltip"><label class="config-label">Leak Test Value:</label>&nbsp;<input disabled="disabled" type="text" id="LEAK_CAL_VAL" name="LEAK_CAL_VAL" value="%LEAK_CAL_VAL%" class="config-text"><span class="tooltiptext">Measured leak test value</span></div><br><div class="float-right"><button id="calibrate-button" class="button">Calibrate Flow Offset</button><button id="leak-cal-button" class="button">Calibrate Leak Test</button></div><br></div></div><script>const GET_FLOW_DATA=1,REC_FLOW_DATA=2,CALIBRATE=3,FILE_LIST=4,SYS_STATUS=5,SAVE_CONFIG=6,LOAD_CONFIG=7,FILE_DOWNLOAD=8,FILE_DELETE=9,FILE_UPLOAD=10,START_BENCH=11,STOP_BENCH=12,LEAK_CAL=13,GET_CAL=14;var leakCalVal,flowCalVal,leakCalTolerance,leakTestThreshold,websocket,gateway=`ws://${window.location.hostname}/ws`;window.addEventListener("load",onLoad);var fileModal=document.getElementById("fileModal"),aboutModal=document.getElementById("aboutModal"),spanCloseFileModal=document.getElementsByClassName("closeFileModal")[0],spanCloseAboutModal=document.getElementsByClassName("closeAboutModal")[0];function initialiseWebSocket(){console.log("Trying to open a WebSocket connection..."),(websocket=new WebSocket(gateway)).onopen=onOpen,websocket.onclose=onClose,websocket.onmessage=onSocketMessageReceive}function onOpen(e){console.log("Connection opened"),socketMessageSend(1),socketMessageSend(7),socketMessageSend(4),socketMessageSend(14)}function onClose(e){console.log("Connection closed"),setTimeout(initialiseWebSocket,2e3)}function onSocketMessageReceive(e){try{var t=JSON.parse(e.data);console.log("Socket Message Event: "+parseInt(t.HEADER))}catch(e){console.log("Malformed JSON data")}switch(key=null,parseInt(t.HEADER)){case 7:for(key in t)try{"HEADER"!=key&&(document.getElementById(key).value=t[key])}catch(e){console.log("Missing or incorrect configuration parameter(s)")}break;case 1:for(key in t)try{"HEADER"!=key&&(document.getElementById(key).innerHTML=t[key],"PREF"==key&&(t[key]>leakCalVal-leakCalTolerance?document.getElementById("PREF").className="prefTestOK":t[key]>leakTestThreshold?document.getElementById("PREF").className="prefTestNOK":document.getElementById("PREF").className="tile-value"))}catch(e){console.log("Missing or incorrect data parameter(s)")}break;case 14:for(key in console.log("get-cal"),t){console.log(key);try{"HEADER"!=key&&(document.getElementById(key).value=t[key],console.log(key+" : "+t[key])),"FLOW_OFFSET"==key&&(flowCalVal=t[key]),"LEAK_CAL_VAL"==key&&(leakCalVal=t[key])}catch(e){console.log("Missing or incorrect calibration parameter(s)")}}break;case 4:var o="";for(key in t){try{"HEADER"!=key&&(o+='<div class="fileListRow"><span class="column left"><a href="/download'+key+'" download class="file-link" onclick="downloadFile("'+key+'")">'+key+'</a></span><span class="column middle"><span class="fileSizeTxt">'+t[key]+' bytes</span></span><span class="column right"><button id="delete-button"  onclick="socketMessageSend(\'9:'+key+'\')" class="button-sml">Del</button></span>')}catch(e){console.log(e),console.log("Missing or incorrect system status")}document.getElementById("file_list").innerHTML=o}break;case 5:for(key in t)try{"HEADER"!=key&&(document.getElementById(key).innerHTML=t[key])}catch(e){console.log("Missing or incorrect status parameter(s)")}}}function onFileUpload(e){this.setState({file:e.target.files[0]});const{file:t}=this.state,o=new FormData;o.append("data",t),fetch("/upload",{method:"POST",body:o}).catch((e=>{console.log("Request failed",e)}))}function onLoad(e){initialiseWebSocket(),initialiseButtons();if("upload"===new URLSearchParams(window.location.search).get("modal"))document.getElementById("load-config-button").click(),document.getElementById("fileModal").style.display="block";else document.getElementById("load-dashboard-button").click();console.log("Page Loaded")}function initialiseButtons(){document.getElementById("refresh-button").addEventListener("click",(function(){socketMessageSend(1)})),document.getElementById("load-config-button").addEventListener("click",(function(){socketMessageSend(7),socketMessageSend(14)})),document.getElementById("calibrate-button").addEventListener("click",(function(){socketMessageSend(3)})),document.getElementById("leak-cal-button").addEventListener("click",(function(){socketMessageSend(13)})),document.getElementById("save-config-button").addEventListener("click",(function(){socketMessageSend(6)})),document.getElementById("file-manager-button").addEventListener("click",(function(){socketMessageSend(4),document.getElementById("fileModal").style.display="block"})),document.getElementById("about-button").addEventListener("click",(function(){socketMessageSend(5),document.getElementById("aboutModal").style.display="block"})),document.getElementById("on-button").addEventListener("click",(function(){socketMessageSend(11)})),document.getElementById("off-button").addEventListener("click",(function(){socketMessageSend(12)}))}function configFormArray(){const e=document.querySelectorAll("form")[1],t=new FormData(e),o={};for(const[e,n]of t)o[e]=n;return o}function socketMessageSend(e){var t,o,n,a,s;switch(console.log("Web Socket Message: "+e),-1!=String(e).search(":")?(n=e.split(":"),a=Number(n[0]),s=n[1]):a=e,a){case 1:t='{"HEADER":"1"}';break;case 2:t='{"HEADER":"2"}';break;case 3:t='{"HEADER":"3"}';break;case 4:t='{"HEADER":"4"}';break;case 5:t='{"HEADER":"5"}';break;case 6:(o=configFormArray()).HEADER=6,t=JSON.stringify(o,null,2);break;case 7:t='{"HEADER":"7"}';break;case 8:case 10:break;case 9:t='{"HEADER":"9","FILENAME":"'+s+'"}';break;case 11:t='{"HEADER":"11"}';break;case 12:t='{"HEADER":"12"}';break;case 13:t='{"HEADER":"13"}';break;case 14:t='{"HEADER":"14"}'}console.log(t),websocket.send(t)}function openPage(e,t){var o,n;for(n=document.getElementsByClassName("tabcontent"),o=0;o<n.length;o++)n[o].style.display="none";document.getElementById(e).style.display="block"}spanCloseFileModal.onclick=function(){fileModal.style.display="none"},spanCloseAboutModal.onclick=function(){aboutModal.style.display="none"},window.onclick=function(e){e.target!=fileModal&&e.target!=aboutModal||(fileModal.style.display="none",aboutModal.style.display="none")},document.addEventListener("keydown",(({key:e})=>{"Escape"===e&&(fileModal.style.display="none",aboutModal.style.display="none")}));</script></body></html>